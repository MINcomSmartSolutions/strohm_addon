<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <record id="email_template_charging_invoice" model="mail.template">
            <field name="name">Charging Invoice - Send by Email</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="subject">Rechnung für Ladevorgang am {{ format_date(object.invoice_date, date_format='dd.MM.yyyy') }}</field>
            <field name="email_from">{{ (object.invoice_user_id.email_formatted or user.email_formatted) }}</field>
            <field name="email_to">{{ object.partner_id.email }}</field>
            <field name="lang">{{ object.partner_id.lang }}</field>
            <field name="auto_delete" eval="False"/>
<!--            FIXME: Need reply to-->
            <field name="report_template_ids" eval="[(4, ref('account.account_invoices'))]"/>
            <field name="body_html" type="html">
                <div
                    style="margin: 0px; padding: 0px; font-family: 'Lucida Grande', 'Verdana', 'Arial', sans-serif; font-size: 14px; color: #333;">
                    <table border="0" cellpadding="0" cellspacing="0"
                           style="width: 100%; background-color: #f9f9f9; padding: 20px;">
                        <tr>
                            <td align="center">
                                <table border="0" cellpadding="0" cellspacing="0"
                                       style="max-width: 600px; width: 100%; background-color: #ffffff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <!-- Header -->
                                    <tr>
                                        <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; text-align: center;">
                                            <h1 style="color: #ffffff; margin: 0; font-size: 28px;">
                                                Information zu Ihrem Ladevorgang
                                            </h1>
                                        </td>
                                    </tr>

                                    <!-- Body -->
                                    <tr>
                                        <td style="padding: 30px;">
                                            <p style="margin: 0 0 15px; font-size: 16px;">Sehr geehrte*r Kund*in,</p>

                                            <p style="margin: 0 0 15px;">
                                                vielen Dank für das Laden Ihres Fahrzeugs an der Hochschule München. Der
                                                nachfolgende Ladevorgang wurde erfolgreich abgeschlossen. Im Zeitraum
                                                bis einschließlich 31. Dezember 2025 fallen für Sie keine Kosten an.
                                            </p>
                                            <p style="margin: 0 0 15px;">
                                                Ab dem 1. Januar 2026 werden Ladevorgänge verbindlich zu den auf dem
                                                Nutzerportal veröffentlichten Tarifen abgerechnet. Bitte berücksichtigen
                                                Sie dies für Ihre zukünftigen Ladevorgänge. Die jeweils gültigen Preise
                                                können Sie jederzeit online einsehen.
                                            </p>

                                            <!-- Charging Session Details -->
                                            <div
                                                style="background-color: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0; border-radius: 4px;">
                                                <h3 style="margin: 0 0 10px; color: #667eea; font-size: 18px;">
                                                    Details zum Ladevorgang
                                                </h3>

                                                <t t-if="object.session_start">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Beginn</strong> <t t-out="object.session_start"
                                                                                   t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                                    </p>
                                                </t>

                                                <t t-if="object.session_end">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Ende</strong> <t t-out="object.session_end"
                                                                                 t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                                    </p>
                                                </t>

                                                <t t-if="object.session_start and object.session_end">
                                                    <t t-set="duration"
                                                       t-value="object.session_end - object.session_start"/>
                                                    <t t-set="hours" t-value="int(duration.total_seconds() // 3600)"/>
                                                    <t t-set="minutes"
                                                       t-value="int((duration.total_seconds() % 3600) // 60)"/>
                                                    <p style="margin: 5px 0;">
                                                        <strong>Ladedauer</strong> <t t-out="hours"/> Std. <t
                                                        t-out="minutes"/> Min.
                                                    </p>
                                                </t>

                                                <t t-set="total_kwh"
                                                   t-value="sum(object.invoice_line_ids.filtered(lambda l: l.product_uom_id and l.product_uom_id.name == 'kWh').mapped('quantity'))"/>
                                                <t t-if="total_kwh > 0">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Geladene Energiemenge</strong> <t
                                                        t-out="'%.2f' % total_kwh"/> kWh
                                                    </p>
                                                </t>
                                            </div>

                                            <!-- Invoice Summary -->
                                            <div
                                                style="background-color: #fff9e6; border-left: 4px solid #ffa500; padding: 15px; margin: 20px 0; border-radius: 4px;">
                                                <h3 style="margin: 0 0 10px; color: #ffa500; font-size: 18px;">
                                                    Rechnungsinformationen
                                                </h3>
                                                <p style="margin: 5px 0;">
                                                    <strong>Rechnungsnummer</strong> <t t-out="object.name or ''"/>
                                                </p>
                                                <p style="margin: 5px 0;">
                                                    <strong>Rechnungsdatum</strong> <t t-out="object.invoice_date"
                                                                                       t-options="{'widget': 'date', 'format': 'dd.MM.yyyy'}"/>
                                                </p>
                                                <t t-if="object.invoice_date_due">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Fälligkeitsdatum</strong> <t
                                                        t-out="object.invoice_date_due"
                                                        t-options="{'widget': 'date', 'format': 'dd.MM.yyyy'}"/>
                                                    </p>
                                                </t>
                                                <p style="margin: 15px 0 5px; font-size: 20px; color: #333;">
                                                    <strong>Gesamtbetrag</strong>
                                                    <span style="color: #667eea; font-size: 24px;"><t
                                                        t-out="object.amount_total"
                                                        t-options="{'widget': 'monetary', 'display_currency': object.currency_id}"/></span>
                                                </p>
                                            </div>

                                            <p style="margin: 20px 0 15px;">
                                                Die detaillierte Rechnung finden Sie im Anhang dieser E-Mail.
                                            </p>

                                            <!-- Call to Action
                                            <t t-if="object.partner_id.id">
                                                <div style="text-align: center; margin: 25px 0;">
                                                    <a t-attf-href="/my/invoices/#{object.id}"
                                                       style="display: inline-block; padding: 12px 30px; background-color: #667eea; color: #ffffff; text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 16px;">
                                                        Rechnung online ansehen
                                                    </a>
                                                </div>
                                            </t>-->

                                            <p>
                                                Falls Ihr Fahrzeug noch am Ladepunkt steht, bitten wir Sie, dieses
                                                zeitnah zu entfernen, damit andere Nutzer*innen die Ladeinfrastruktur
                                                verwenden können.
                                            </p>

                                            <p style="margin: 20px 0 0; font-size: 13px; color: #666;">
                                                Bei Fragen zu dieser Rechnung können Sie uns jederzeit kontaktieren.
                                            </p>
                                        </td>
                                    </tr>

                                    <!-- Footer TODO: Should be hardcoded HM contact data.-->
                                    <tr>
                                        <td style="background-color: #f5f5f5; padding: 20px; text-align: center; border-top: 1px solid #e0e0e0;">
                                            <p style="margin: 0 0 10px; color: #666; font-size: 12px;">
                                                Hochschule München<br/>
                                                Administration Ladeservice<br/>
                                                E-Mail: charging-support@hm.edu
                                            </p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            </field>
        </record>
    </data>
</odoo>

