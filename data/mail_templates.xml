<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!-- Email Template for Invoice Confirmation (with PDF attachment) -->
        <record id="email_template_charging_invoice" model="mail.template">
            <field name="name">Ladevorgang - Rechnung bestätigt</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="subject">{{ 'Ihre Rechnung zum Ladevorgang' if len(object.invoice_line_ids) == 1 else 'Ihre Rechnung zu Ladevorgängen' }}{{ (' am ' + format_date(object.session_start, date_format='dd.MM.yyyy')) if (len(object.invoice_line_ids) == 1 and object.session_start) else '' }}{{ (' - %.2f kWh' % object.total_kwh) if (len(object.invoice_line_ids) == 1 and object.total_kwh) else '' }}</field>
            <field name="email_from">{{ object.company_id.name }} &lt;no-reply.laden@hm.edu&gt;</field>
            <field name="email_to">{{ object.partner_id.email }}</field>
            <field name="reply_to">&lt;abrechnung.laden@hm.edu&gt;</field>
            <field name="lang">{{ object.partner_id.lang }}</field>
            <field name="description">Sent automatically when a charging invoice is confirmed. Includes PDF invoice attachment.</field>
            <field name="auto_delete" eval="False"/>
            <field name="report_template_ids" eval="[(4, ref('account.account_invoices'))]"/>
            <field name="body_html" type="html">
                <div
                    style="margin: 0; padding: 0; font-family: 'Segoe UI','Roboto','Lucida Grande', 'Verdana', 'Arial', sans-serif; font-size: 14px; color: #333;">
                    <table border="0" cellpadding="0" cellspacing="0"
                           style="width: 100%; background-color: #f9f9f9; padding: 20px;">
                        <tr>
                            <td align="center">
                                <table border="0" cellpadding="0" cellspacing="0"
                                       style="max-width: 600px; background-color: white; overflow: hidden; color: #161616; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <!-- Body -->
                                    <tr>
                                        <td style="padding: 30px;">
                                            <p style="margin: 0 0 15px; font-size: 16px;">Sehr geehrte*r <t
                                                t-out="object.partner_id.name or 'Kund*in'"/>,</p>

                                            <p style="margin: 0 0 15px;">
                                                Ihre Rechnung für den Ladevorgang an der Hochschule München wurde erstellt.
                                                Die Abrechnung der Energiemengen erfolgt auf Basis des jeweils gültigen Ladetarifs, den Sie im <a href="https://laden.hm.edu/my/invoices">Nutzerportal</a> einsehen können.
                                            </p>
                                            <p style="margin: 0 0 15px;">
                                                Voraussichtlich bis spätestens Mai 2026 wird eine Lösung bereitstehen, mit der Sie Ihre Rechnungen über das Landesamt für Finanzen begleichen können.
                                                Bis dahin werden Ihre Rechnungen im Portal gesammelt; die bis dahin angefallenen Beträge sind anschließend über das Landesamt für Finanzen zu bezahlen.
                                            </p>

                            <!-- Charging Session Details -->
                                <div style="background-color: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0;">
                                    <t t-if="len(object.invoice_line_ids) == 1">
                                        <h3 style="margin: 0 0 10px; color: #667eea; font-size: 18px;">
                                            Details zum Ladevorgang
                                        </h3>

                                        <t t-if="object.session_start">
                                            <p style="margin: 5px 0;">
                                                <strong>Beginn:</strong> <t t-out="object.session_start"
                                                                            t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                            </p>
                                        </t>

                                        <t t-if="object.session_end">
                                            <p style="margin: 5px 0;">
                                                <strong>Ende:</strong> <t t-out="object.session_end"
                                                                          t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                            </p>
                                        </t>

                                        <t t-if="object.session_start and object.session_end">
                                            <t t-set="duration"
                                               t-value="object.session_end - object.session_start"/>
                                            <t t-set="hours" t-value="int(duration.total_seconds() // 3600)"/>
                                            <t t-set="minutes"
                                               t-value="int((duration.total_seconds() % 3600) // 60)"/>
                                            <p style="margin: 5px 0;">
                                                <strong>Ladedauer:</strong> <t t-out="hours"/> Std. <t t-out="minutes"/> Min.
                                            </p>
                                        </t>
                                        <t t-set="total_kwh"
                                           t-value="sum(object.invoice_line_ids.filtered(lambda l: l.product_uom_id and l.product_uom_id.name == 'kWh').mapped('quantity'))"/>
                                        <t t-if="total_kwh >= 0">
                                            <p style="margin: 5px 0;">
                                                <strong>Geladene Energiemenge:</strong> <t
                                                t-out="'%.2f' % total_kwh"/> kWh
                                            </p>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <h3 style="margin: 0 0 10px; color: #667eea; font-size: 18px;">
                                            Details zu den Ladevorgängen
                                        </h3>

                                        <p style="margin: 5px 0;">
                                            Diese Rechnung umfasst mehrere Ladevorgänge. Detaillierte Informationen zu den einzelnen Ladevorgängen finden Sie in der angehängten Rechnung.
                                        </p>

                                         <t t-if="object.session_start">
                                            <p style="margin: 5px 0;">
                                                <strong>Abrechnungszeitraum Beginn:</strong> <t t-out="object.session_start"
                                                                            t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                            </p>
                                        </t>

                                        <t t-if="object.session_end">
                                            <p style="margin: 5px 0;">
                                                <strong>Abrechnungszeitraum Ende:</strong> <t t-out="object.session_end"
                                                                          t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                            </p>
                                        </t>

                                        <t t-set="total_kwh"
                                            t-value="sum(object.invoice_line_ids.filtered(lambda l: l.product_uom_id and l.product_uom_id.name == 'kWh').mapped('quantity'))"/>
                                        <t t-if="total_kwh >= 0">
                                            <p style="margin: 5px 0;">
                                                <strong>Gesamte geladene Energiemenge:</strong> <t
                                                t-out="'%.2f' % total_kwh"/> kWh
                                            </p>
                                        </t>
                                    </t>
                                </div>
                                            <div
                                                style="background-color: #fff9e6; border-left: 4px solid #ffa500; padding: 15px; margin: 20px 0;">
                                                <h3 style="margin: 0 0 10px; color: #ffa500; font-size: 18px;">
                                                    Preisinformation
                                                </h3>
                                                <p style="margin: 15px 0 5px; font-size: 20px; color: #333;">
                                                    <strong>Gesamtbetrag:</strong>
                                                    <span style="font-size: 24px;"><t
                                                        t-out="object.amount_total"
                                                        t-options="{'widget': 'monetary', 'display_currency': object.currency_id}"/></span>
                                                </p>
                                            </div>

                                            <p style="margin: 20px 0 15px;">
                                                Die detaillierte Rechnung finden Sie im Anhang dieser E-Mail.
                                                Zusätzlich können Sie alle Ihre Rechnungen jederzeit in Ihrem
                                                <a href="https://laden.hm.edu/my/invoices">Nutzerportal</a> einsehen.
                                            </p>

                                            <p style="margin: 20px 0 0; font-size: 13px; color: #666;">
                                                Sollten Sie Fragen zum Ladeservice oder zur Rechnung haben, stehen wir Ihnen gerne zur
                                                Verfügung. Bitte antworten Sie nicht direkt auf diese E-Mail.
                                            </p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #f5f5f5; padding: 20px; text-align: center; border-top: 1px solid #e0e0e0;">
                                            <p style="margin: 0 0 10px; color: #666; font-size: 12px;">
                                                <t t-out="object.company_id.name or ''"/><br/>
                                                Administration Ladeservice<br/>
                                                info.laden@hm.edu<br/>
                                                Bei Fragen zu Rechnungen: abrechnung.laden@hm.edu
                                            </p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            </field>
        </record>

        <!-- Email Template for Sale Order Confirmation (session completed notification) -->
        <record id="email_template_charging_session_completed" model="mail.template">
            <field name="name">Ladevorgang - Sitzung abgeschlossen</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="subject">Information zu Ihrem Ladevorgang{{ (' am ' + format_date(object.session_start, date_format='dd.MM.yyyy')) if object.session_start else '' }}{{ (' - %.2f kWh' % object.total_kwh) if object.total_kwh else '' }}</field>
            <field name="email_from">{{ object.company_id.name }} &lt;no-reply.laden@hm.edu&gt;</field>
            <field name="email_to">{{ object.partner_id.email }}</field>
            <field name="reply_to">&lt;abrechnung.laden@hm.edu&gt;</field>
            <field name="lang">{{ object.partner_id.lang }}</field>
            <field name="description">Sent automatically when a charging session sale order is confirmed. No attachment - directs user to portal.</field>
            <field name="auto_delete" eval="False"/>
            <field name="body_html" type="html">
                <div
                    style="margin: 0; padding: 0; font-family: 'Segoe UI','Roboto','Lucida Grande', 'Verdana', 'Arial', sans-serif; font-size: 14px; color: #333;">
                    <table border="0" cellpadding="0" cellspacing="0"
                           style="width: 100%; background-color: #f9f9f9; padding: 20px;">
                        <tr>
                            <td align="center">
                                <table border="0" cellpadding="0" cellspacing="0"
                                       style="max-width: 600px; background-color: white; overflow: hidden; color: #161616; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <!-- Body -->
                                    <tr>
                                        <td style="padding: 30px;">
                                            <p style="margin: 0 0 15px; font-size: 16px;">Sehr geehrte*r <t
                                                t-out="object.partner_id.name or 'Kund*in'"/>,</p>

                                            <p style="margin: 0 0 15px;">
                                                vielen Dank für das Laden Ihres Fahrzeugs an der Hochschule München. Der nachfolgende Ladevorgang wurde erfolgreich abgeschlossen.
                                                Die Abrechnung der Energiemengen erfolgt auf Basis des jeweils gültigen Ladetarifs, den Sie im <a href="https://laden.hm.edu/my/invoices">Nutzerportal</a> einsehen können.
                                            </p>
                                            <p style="margin: 0 0 15px;">
                                                Voraussichtlich bis spätestens Mai 2026 wird eine Lösung bereitstehen, mit der Sie Ihre Rechnungen über das Landesamt für Finanzen begleichen können.
                                                Bis dahin werden Ihre Ladevorgänge im Portal gesammelt; die bis dahin angefallenen Beträge sind anschließend über das Landesamt für Finanzen zu bezahlen.
                                            </p>

                                            <!-- Charging Session Details -->
                                            <div
                                                style="background-color: #f0f7ff; border-left: 4px solid #667eea; padding: 15px; margin: 20px 0;">
                                                <h3 style="margin: 0 0 10px; color: #667eea; font-size: 18px;">
                                                    Details zum Ladevorgang
                                                </h3>

                                                <t t-if="object.session_start">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Beginn:</strong> <t t-out="object.session_start"
                                                                                    t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                                    </p>
                                                </t>

                                                <t t-if="object.session_end">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Ende:</strong> <t t-out="object.session_end"
                                                                                  t-options="{'widget': 'datetime', 'tz_name': object.partner_id.tz or 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                                                    </p>
                                                </t>

                                                <t t-if="object.session_start and object.session_end">
                                                    <t t-set="duration"
                                                       t-value="object.session_end - object.session_start"/>
                                                    <t t-set="hours" t-value="int(duration.total_seconds() // 3600)"/>
                                                    <t t-set="minutes"
                                                       t-value="int((duration.total_seconds() % 3600) // 60)"/>
                                                    <p style="margin: 5px 0;">
                                                        <strong>Ladedauer:</strong> <t t-out="hours"/> Std. <t
                                                        t-out="minutes"/> Min.
                                                    </p>
                                                </t>

                                                <t t-if="object.total_kwh >= 0">
                                                    <p style="margin: 5px 0;">
                                                        <strong>Geladene Energiemenge:</strong> <t
                                                        t-out="'%.2f' % object.total_kwh"/> kWh
                                                    </p>
                                                </t>
                                            </div>

                                            <!-- Price Summary -->
                                            <div
                                                style="background-color: #fff9e6; border-left: 4px solid #ffa500; padding: 15px; margin: 20px 0;">
                                                <h3 style="margin: 0 0 10px; color: #ffa500; font-size: 18px;">
                                                    Preisinformation
                                                </h3>
                                                <p style="margin: 15px 0 5px; font-size: 20px; color: #333;">
                                                    <strong>Gesamtbetrag:</strong>
                                                    <span style="font-size: 24px;"><t
                                                        t-out="object.amount_total"
                                                        t-options="{'widget': 'monetary', 'display_currency': object.currency_id}"/></span>
                                                </p>
                                            </div>

                                            <p style="margin: 20px 0 15px;">
                                                Alle Details zu Ihren Ladevorgängen können Sie jederzeit in Ihrem
                                                <a href="https://laden.hm.edu/my/home">Nutzerportal</a> einsehen.
                                                Die Rechnungerstellung erfolgt nach dem Quartalsende.
                                            </p>
                                            <p>
                                                Falls Ihr Fahrzeug noch am Ladepunkt steht, bitten wir Sie, dieses
                                                zeitnah zu entfernen, damit andere Nutzer*innen die Ladeinfrastruktur
                                                verwenden können.
                                            </p>

                                            <p style="margin: 20px 0 0; font-size: 13px; color: #666;">
                                                Sollten Sie Fragen zum Ladeservice haben, stehen wir Ihnen gerne zur
                                                Verfügung. Bitte antworten Sie nicht direkt auf diese E-Mail.
                                            </p>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="background-color: #f5f5f5; padding: 20px; text-align: center; border-top: 1px solid #e0e0e0;">
                                            <p style="margin: 0 0 10px; color: #666; font-size: 12px;">
                                                <t t-out="object.company_id.name or ''"/><br/>
                                                Administration Ladeservice<br/>
                                                info.laden@hm.edu<br/>
                                                Bei Fragen zu Rechnungen: abrechnung.laden@hm.edu
                                            </p>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </table>
                </div>
            </field>
        </record>

        <!-- Automation: Send email when Invoice is confirmed (posted) -->
        <record id="automation_invoice_confirmed_send_email" model="base.automation">
            <field name="name">Send Email on Invoice Confirmation</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="trigger">on_write</field>
            <field name="trigger_field_ids" eval="[(4, ref('account.field_account_move__state'))]"/>
            <field name="filter_pre_domain" eval="[('state', '!=', 'posted'), ('move_type', '=', 'out_invoice')]"/>
            <field name="filter_domain" eval="[('state', '=', 'posted'), ('move_type', '=', 'out_invoice')]"/>
            <field name="active" eval="False"/>
        </record>

        <record id="server_action_invoice_confirmed_send_email" model="ir.actions.server">
            <field name="name">Send Charging Invoice Email - Action</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
template = env.ref('strohm_addon.email_template_charging_invoice', raise_if_not_found=False)
if template:
    for rec in records:
        template.send_mail(rec.id, force_send=True)
]]></field>
            <field name="usage">base_automation</field>
            <field name="base_automation_id" ref="automation_invoice_confirmed_send_email"/>
        </record>

        <!-- Automation: Send email when Sale Order is confirmed -->
        <record id="automation_sale_order_confirmed_send_email" model="base.automation">
            <field name="name">Send Email on Sale Order Confirmation</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="trigger">on_write</field>
            <field name="trigger_field_ids" eval="[(4, ref('sale.field_sale_order__state'))]"/>
            <field name="filter_pre_domain" eval="[('state', '!=', 'sale')]"/>
            <field name="filter_domain" eval="[('state', '=', 'sale')]"/>
            <field name="active" eval="False"/>
        </record>

        <record id="server_action_sale_order_confirmed_send_email" model="ir.actions.server">
            <field name="name">Send Charging Session Completed Email - Action</field>
            <field name="model_id" ref="sale.model_sale_order"/>
            <field name="state">code</field>
            <field name="code"><![CDATA[
template = env.ref('strohm_addon.email_template_charging_session_completed', raise_if_not_found=False)
if template:
    for rec in records:
        template.send_mail(rec.id, force_send=True)
]]></field>
            <field name="usage">base_automation</field>
            <field name="base_automation_id" ref="automation_sale_order_confirmed_send_email"/>
        </record>
    </data>
</odoo>
