<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        <!-- Disable 2FA for portal users only -->
        <record id="disable_2fa_portal_users" model="ir.cron">
            <field name="name">Disable 2FA for Portal Users</field>
            <field name="model_id" ref="base.model_res_users"/>
            <field name="nextcall" eval="(DateTime.now().replace(hour=3, minute=30) + timedelta(days=1)).strftime('%Y-%m-%d %H:%M:%S')" />
            <field name="state">code</field>
            <field name="code"><![CDATA[
# Disable 2FA for portal users only
portal_group = env.ref('base.group_portal')
# Find portal users with 2FA enabled using totp_enabled field (which has proper search support)
portal_users_with_2fa = model.sudo().search([
    ('totp_enabled', '=', True),
    ('groups_id', 'in', [portal_group.id])
])
if portal_users_with_2fa:
    # Revoke all trusted devices
    portal_users_with_2fa._revoke_all_devices()
    # Disable 2FA by setting totp_secret to False
    portal_users_with_2fa.write({'totp_secret': False})
]]></field>
            <field name="interval_number">1</field>
            <field name="interval_type">minutes</field>
            <field name="active">True</field>
        </record>
    </data>
</odoo>
