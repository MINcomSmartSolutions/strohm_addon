<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Set default title for all portal pages -->
    <template id="custom_portal_layout_title" inherit_id="portal.portal_layout" name="Custom Portal Layout Title">
        <xpath expr="//t[@t-call='portal.frontend_layout']" position="inside">
            <t t-set="title" t-value="title or 'Portal - HM Laden'"/>
            <t t-set="x_icon">https://mediapool.hm.edu/media/_technik/img/_technik_1/favicon.jpg</t>
        </xpath>
    </template>
    <!-- Disable sale orders/quotations from portal home page using data record -->
    <record id="sale.portal_my_home_sale" model="ir.ui.view">
        <field name="active" eval="False"/>
    </record>

    <!-- Override portal_my_security template to remove password change section -->
    <template id="custom_sec" inherit_id="portal.portal_my_security" name="Custom Portal Security Fields" active='true'>
        <xpath expr="//t[@t-call='portal.portal_layout']" position="inside">
            <t t-set="title">HM Laden - Security</t>
        </xpath>
        <!-- Remove password change section -->
        <xpath expr="//section[@name='portal_change_password']" position="replace">
            <!-- This removes the password change section -->
        </xpath>

        <xpath expr="//section[@name='portal_revoke_all_devices_popup']" position="replace">
            <!-- This removes the revoke all devices popup no need for now-->
        </xpath>

        <!-- Modify account deactivation section -->
        <xpath expr="//section[@name='portal_deactivate_account']//form//hr" position="replace">
        <!-- Remove the horizontal line -->
        </xpath>

        <!-- Modify account deactivation section -->
        <xpath expr="//p[@class='text-muted']//b" position="inside">
            <br/>Sie dürfen Ihr Konto nicht löschen, wenn Sie offene Rechnungen oder laufende Ladesitzungen haben.
            Informationen zu den Richtlinien für die Datenlöschung finden Sie in den <a href="https://backend.laden.hm.edu/faq">FAQ</a>.
        </xpath>

        <!-- Add error message display for deactivate account -->
        <xpath expr="//section[@name='portal_deactivate_account']//form" position="inside">
            <div t-if="error_message" class="alert alert-danger mt-2" role="alert">
                <t t-esc="error_message"/>
            </div>
        </xpath>

        <!-- Override the account deactivation section to remove password verification -->
        <xpath expr="//section[@name='portal_deactivate_account']//form//p[2]" position="replace">
            <!-- Remove the password verification text -->
        </xpath>

        <xpath expr="//section[@name='portal_deactivate_account']//input[@name='password']" position="replace">
            <!-- Remove the password input field -->
        </xpath>
        <xpath expr="//section[@name='portal_deactivate_account']//label[@for='request_blacklist']" position="replace">
            <!-- Remove the blacklist request label -->
        </xpath>
        <xpath expr="//section[@name='portal_deactivate_account']//input[@name='request_blacklist']" position="replace">
            <!-- Remove the blacklist request checkbox -->
        </xpath>

    </template>

    <!-- Completely disable TOTP portal section -->
    <template id="disable_totp_portal" inherit_id="auth_totp_portal.totp_portal_hook" name="Disable TOTP Portal" active='true'>
        <xpath expr="//div[@id='totp_wizard_view']" position="replace">
            <!-- Remove TOTP wizard view -->
        </xpath>
        <xpath expr="//section[h4/a[@href='https://www.odoo.com/documentation/master/applications/general/auth/2fa.html']]" position="replace">
            <!-- Remove entire TOTP section by targeting the documentation link which doesn't change with localization -->
        </xpath>
    </template>

    <!-- Override payment methods page title and favicon -->
    <template id="custom_payment_methods_title" inherit_id="payment.payment_methods" name="Custom Payment Methods Title">
        <xpath expr="//t[@t-call='portal.frontend_layout']" position="inside">
            <t t-set="title">Zahlungsmethoden</t>
            <t t-set="x_icon">https://mediapool.hm.edu/media/_technik/img/_technik_1/favicon.jpg</t>
        </xpath>
    </template>

    <template id="portal_active_charging_session_notice" inherit_id="portal.portal_my_home" name="Portal Active Charging Session Notice">
        <xpath expr="//div[hasclass('o_portal_my_home')]" position="before">
                <t t-if="has_active_charging_session">
                   <div id="charging_session_alert" class="alert alert-info" style="position: relative;">
                       <span class="blink-dot" style="position: absolute; top: 10px; right: 10px; display: inline-block; width: 8px; height: 8px; background-color: #0dcaf0; border-radius: 50%; animation: blink 1s infinite;"></span>
                       <p class="mb-2"><strong>You have an active charging session</strong></p>
                       <t t-if="active_charging_session_data and active_charging_session_data.get('start_timestamp')">
                           <p class="mb-0">Duration: <span id="charging_timer" t-att-data-start-time="active_charging_session_data['start_timestamp']">00:00:00</span></p>
                           <div id="charging_warning" class="mt-3" style="display: none;">
                               <p class="mb-0"><strong>⚠️ Notice:</strong> Your charging session has been running for over 10 hours. Please remember to remove your vehicle so that other users can also use the charging infrastructure.</p>
                           </div>
                           <script type="text/javascript">
                               (function() {
                                   var timerElement = document.getElementById('charging_timer');
                                   var warningElement = document.getElementById('charging_warning');
                                   var alertElement = document.getElementById('charging_session_alert');
                                   if (!timerElement) return;

                                   var startTime = new Date(timerElement.getAttribute('data-start-time'));
                                   var TEN_HOURS_MS = 10 * 60 * 60 * 1000;

                                   function updateTimer() {
                                       var now = new Date();
                                       var diff = now - startTime;

                                       var days = Math.floor(diff / (1000 * 60 * 60 * 24));
                                       var hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                                       var minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                                       var seconds = Math.floor((diff % (1000 * 60)) / 1000);

                                       var timeStr = '';
                                       if (days > 0) {
                                          if (days === 1) {
                                              timeStr += days + 'Tag ';
                                          } else {
                                              timeStr += days + 'Tage ';
                                          }
                                       }
                                       timeStr += String(hours).padStart(2, '0') + ':' +
                                                  String(minutes).padStart(2, '0') + ':' +
                                                  String(seconds).padStart(2, '0');

                                       timerElement.textContent = timeStr;

                                       // Show warning if more than 10 hours
                                       if (diff > TEN_HOURS_MS) {
                                           if (warningElement) {
                                               warningElement.style.display = 'block';
                                           }
                                           if (alertElement) {
                                               alertElement.classList.remove('alert-info');
                                               alertElement.classList.add('alert-warning');
                                           }
                                       }
                                   }

                                   updateTimer();
                                   setInterval(updateTimer, 1000);
                               })();
                           </script>
                           <style>
                               @keyframes blink {
                                   0%, 50% { opacity: 1; }
                                   51%, 100% { opacity: 0; }
                               }
                           </style>
                       </t>
                   </div>
                </t>
        </xpath>
    </template>

    <template id="portal_current_electricity_price" inherit_id="portal.portal_my_home" name="Portal Current Electricity Price">
        <xpath expr="//div[hasclass('o_portal_my_home')]" position="before">
                <t t-if="electricity_price_ct_kwh is not None">
                    <p class="alert alert-info">Current Electricity Price is <b><t t-esc="electricity_price_ct_kwh"/> ct/kWh</b></p>
                </t>
        </xpath>
    </template>
</odoo>
