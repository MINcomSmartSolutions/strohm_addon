<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Inherit the standard invoice document and add charging session info -->
        <template id="report_invoice_document_charging" inherit_id="account.report_invoice_document">
            <!-- Add charging session information after the informations div -->
            <xpath expr="//div[@id='informations']" position="after">
                <!-- Count lines with session data -->
                <t t-set="session_lines" t-value="o.invoice_line_ids.filtered(lambda l: l.session_start or l.session_end)"/>
                <t t-set="session_count" t-value="len(session_lines)"/>
                
                <!-- Single Session: Show Ladesitzungsdetails block -->
                <div class="row mb-4" t-if="session_count == 1 and (o.session_start or o.session_end)">
                    <div class="col-12">
                        <div class="alert alert-info"
                             style="background-color: rgb(243, 243, 243); border-radius: 0; border: 1px solid black;">
                            <div class="row">
                                <div class="col-6">
                                    <h5 style="font-size: 1.2rem; line-height: 1.4rem; letter-spacing: -0.44px; margin-bottom: 1rem; margin-top: 0; font-weight: 400;">
                                        Charging Session Details</h5>
                                </div>
                            </div>
                            <br/>
                            <div class="row" style="margin-bottom: 1rem;">
                                <div class="col-3" t-if="o.session_start">
                                    <strong>Session Start</strong><br/>
                                    <span t-esc="o.session_start"
                                          t-options="{'widget': 'datetime', 'tz_name': 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm:ss'}"/>
                                </div>
                                <div class="col-3" t-if="o.session_end">
                                    <strong>Session End</strong><br/>
                                    <span t-esc="o.session_end"
                                          t-options="{'widget': 'datetime', 'tz_name': 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm:ss'}"/>
                                </div>
                            </div>
                            <div class="row">
                                <t t-set="total_kwh"
                                   t-value="sum((line.quantity for line in o.invoice_line_ids.filtered(lambda l: l.product_uom_id and l.product_uom_id.name == 'kWh')), 0)"/>
                                <t t-set="has_duration" t-value="o.session_start and o.session_end"/>
                                <t t-if="has_duration" t-set="duration" t-value="o.session_end - o.session_start"/>
                                <t t-if="has_duration" t-set="duration_hours"
                                   t-value="duration.total_seconds() / 3600"/>
                                <div class="col-3">
                                    <strong>Charged Energy</strong><br/>
                                    <span t-if="total_kwh > 0" class="text" style="font-size: 1.1em;"
                                          t-esc="'%.2f kWh' % total_kwh"/>
                                    <span t-if="total_kwh == 0" class="text-muted">0.0</span>
                                </div>
                                <div class="col-3" t-if="has_duration">
                                    <strong>Charging Duration</strong><br/>
                                    <t t-set="hours" t-value="int(duration.total_seconds() // 3600)"/>
                                    <t t-set="minutes" t-value="int((duration.total_seconds() % 3600) // 60)"/>
                                    <t t-set="seconds" t-value="int(duration.total_seconds() % 60)"/>
                                    <span class="text" style="font-size: 1.1em;">
                                        <t t-esc="hours"/> h <t t-esc="minutes"/> min <t t-esc="seconds"/> sec
                                    </span>
                                </div>
                                <div class="col-6" t-if="total_kwh > 0 and has_duration and duration_hours > 0">
                                    <strong>Average Power</strong><br/>
                                    <span class="text" style="font-size: 1.1em;"
                                          t-esc="'%.2f kW' % (total_kwh / duration_hours)"/>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </xpath>

            <!-- Remove product reference (default_code) from invoice line names -->
            <xpath expr="//td[@name='account_invoice_line_name']//span[@t-field='line.name']" position="replace">
                <span t-if="line.name">
                    <t t-set="clean_name"
                       t-value="line.name.split(']')[-1].strip() if ']' in line.name else line.name"/>
                    <span t-esc="clean_name"/>
                </span>
            </xpath>

            <!-- Add kWh suffix to quantity for energy lines -->
            <xpath expr="//td[@name='td_quantity']" position="replace">
                <td name="td_quantity" class="o_td_quantity text-end">
                    <t t-if="line.product_uom_id.name == 'kWh'">
                        <span class="text-nowrap" t-esc="'%.2f kWh' % line.quantity"/>
                    </t>
                    <t t-else="">
                        <span t-field="line.quantity" class="text-nowrap"/>
                        <span t-field="line.product_uom_id" groups="uom.group_uom"/>
                    </t>
                </td>
            </xpath>

            <!-- Add Verweis (Reference) column to invoice lines table header -->
            <xpath expr="//table[@name='invoice_line_table']//th[@name='th_description']" position="before">
                <t t-set="has_refs" t-value="any(line.sale_line_ids for line in o.invoice_line_ids.filtered(lambda l: l.display_type == 'product'))"/>
                <th t-if="has_refs" name="th_reference" class="text-start">
                <span>Reference</span></th>
            </xpath>

            <!-- Add Verweis (Reference) column to invoice lines table body -->
            <xpath expr="//td[@name='account_invoice_line_name']" position="before">
                <t t-set="has_refs" t-value="any(line.sale_line_ids for line in o.invoice_line_ids.filtered(lambda l: l.display_type == 'product'))"/>
                <td t-if="has_refs" name="td_reference" class="text-start">
                    <span t-if="line.sale_line_ids" t-esc="line.sale_line_ids[0].order_id.name"/>
                    <span t-else="" class="text-muted">-</span>
                </td>
            </xpath>

            <!-- Add session columns to invoice lines table header for multiple sessions -->
            <xpath expr="//table[@name='invoice_line_table']//th[@name='th_subtotal']" position="before">
                <t t-set="session_lines_check" t-value="o.invoice_line_ids.filtered(lambda l: l.session_start or l.session_end)"/>
                <th t-if="len(session_lines_check) &gt; 1" name="th_session_start" class="text-start">
                    <span>Start</span>
                </th>
                <th t-if="len(session_lines_check) &gt; 1" name="th_session_end" class="text-start">
                <span>End</span>
                </th>
            </xpath>

            <!-- Add session columns to invoice lines table body for multiple sessions -->
            <xpath expr="//table[@name='invoice_line_table']//td[@name='td_subtotal']" position="before">
                <t t-set="session_lines_check" t-value="o.invoice_line_ids.filtered(lambda l: l.session_start or l.session_end)"/>
                <td t-if="len(session_lines_check) &gt; 1" name="td_session_start" class="text-start">
                    <span t-if="line.session_start" t-esc="line.session_start" t-options="{'widget': 'datetime', 'tz_name': 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                    <span t-else="" class="text-muted">-</span>
                </td>
                <td t-if="len(session_lines_check) &gt; 1" name="td_session_end" class="text-start">
                    <span t-if="line.session_end" t-esc="line.session_end" t-options="{'widget': 'datetime', 'tz_name': 'Europe/Berlin', 'format': 'dd.MM.yyyy HH:mm'}"/>
                    <span t-else="" class="text-muted">-</span>
                </td>
            </xpath>
        </template>
    </data>
</odoo>
