<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="portal_my_invoices_inherit" name="Portal My Invoices - Add Charging Fields" inherit_id="account.portal_my_invoices">
        <!-- Extend the invoice portal table -->
        <xpath expr="//t[@t-call='portal.portal_layout']" position="inside">
            <t t-set="use_wide_container" t-value="True"/>
        </xpath>

        <!-- Add extra header columns for charging session data -->
        <xpath expr="//thead/tr/th[@name='invoice_date']" position="after">
            <th name="session_start" class="d-none d-lg-table-cell">Session Start</th>
            <th name="session_end" class="d-none d-lg-table-cell">Session End</th>
            <th name="total_kwh" class="d-none d-md-table-cell">Charged Energy (kWh)</th>
            <th name="price_unit" class="d-none d-md-table-cell">Price per kWh</th>
        </xpath>

        <!-- Add extra data columns for charging session data -->
        <xpath expr="//tbody/t/tr/td[2]" position="after">
            <td class="d-none d-lg-table-cell">
                <span t-if="invoice.session_start" t-field="invoice.session_start" t-options='{"widget": "datetime", "tz_name": "Europe/Berlin", "format": "dd.MM.yyyy HH:mm"}'/>
                <span t-else="" class="text-muted">-</span>
            </td>
            <td class="d-none d-lg-table-cell">
                <span t-if="invoice.session_end" t-field="invoice.session_end" t-options='{"widget": "datetime", "tz_name": "Europe/Berlin", "format": "dd.MM.yyyy HH:mm"}'/>
                <span t-else="" class="text-muted">-</span>
            </td>
            <td class="d-none d-md-table-cell">
                <t t-if="invoice.total_kwh > 0">
                    <span t-esc="'%.2f' % invoice.total_kwh"/>
                </t>
                <span t-else="" class="text-muted">-</span>
            </td>
            <td class="d-none d-md-table-cell">
                <t t-set="kwh_line" t-value="invoice.sudo().invoice_line_ids.filtered(lambda l: l.product_uom_id and l.product_uom_id.name == 'kWh')[:1]"/>
                <t t-if="kwh_line">
                    <span t-esc="'%.2f' % kwh_line.price_unit"/>
                </t>
                <span t-else="" class="text-muted">-</span>
            </td>
        </xpath>
    </template>
</odoo>

