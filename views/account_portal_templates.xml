<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Sales Order Portal - Add Charging Fields -->
    <template id="portal_my_orders_inherit" name="Portal My Orders - Add Charging Fields" inherit_id="sale.portal_my_orders">
        <!-- Extend the sales order portal table -->
        <xpath expr="//t[@t-call='portal.portal_layout']" position="inside">
            <t t-set="use_wide_container" t-value="True"/>
        </xpath>

        <!-- Add extra header columns for charging session data (before Total column) -->
        <xpath expr="//t[@t-call='portal.portal_table']/thead/tr/th[last()]" position="before">
            <th class="text-end d-none d-lg-table-cell">Session Start</th>
            <th class="text-end d-none d-lg-table-cell">Session End</th>
            <th class="text-end d-none d-md-table-cell">Charged Energy</th>
            <th class="text-end d-none d-md-table-cell">Price per kWh</th>
        </xpath>

        <!-- Add extra data columns for charging session data (before Total column) -->
        <xpath expr="//t[@t-foreach='orders']/tr/td[last()]" position="before">
            <td class="text-end d-none d-lg-table-cell">
                <span t-if="order.session_start" t-field="order.session_start" t-options='{"widget": "datetime", "tz_name": "Europe/Berlin", "format": "dd.MM.yyyy HH:mm"}'/>
                <span t-else="" class="text-muted">-</span>
            </td>
            <td class="text-end d-none d-lg-table-cell">
                <span t-if="order.session_end" t-field="order.session_end" t-options='{"widget": "datetime", "tz_name": "Europe/Berlin", "format": "dd.MM.yyyy HH:mm"}'/>
                <span t-else="" class="text-muted">-</span>
            </td>
            <td class="text-end d-none d-md-table-cell">
                <t t-if="order.total_kwh > 0">
                    <span t-esc="'%.2f kWh' % order.total_kwh"/>
                </t>
                <span t-else="" class="text-muted">-</span>
            </td>
            <td class="text-end d-none d-md-table-cell">
                <t t-set="kwh_line" t-value="order.sudo().order_line.filtered(lambda l: l.product_uom and l.product_uom.name == 'kWh')[:1]"/>
                <t t-if="kwh_line">
                    <span t-esc="'%.2f â‚¬/kWh' % kwh_line.price_unit"/>
                </t>
                <span t-else="" class="text-muted">-</span>
            </td>
        </xpath>
    </template>
</odoo>

